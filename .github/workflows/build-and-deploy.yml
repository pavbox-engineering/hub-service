name: Build and Deploy

on:
  push:
    branches:
      - main
env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}

jobs:
  detect-changes:
    name: Detect Changed Projects
    runs-on: ubuntu-latest
    outputs:
      telegram-bots: ${{ steps.changes.outputs.telegram-bots }}
      api-services: ${{ steps.changes.outputs.api-services }}
      web-apps: ${{ steps.changes.outputs.web-apps }}
      projects: ${{ steps.detect.outputs.projects }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changes
        uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            telegram-bots:
              - 'telegram-bots/**'
            api-services:
              - 'api-services/**'
            web-apps:
              - 'web-apps/**'

      - name: Find specific changed projects
        id: detect
        run: |
          CHANGED_PROJECTS=""
          
          # Проверяем изменения в telegram-bots
          if [[ "${{ steps.changes.outputs.telegram-bots }}" == "true" ]]; then
            for dir in telegram-bots/*/; do
              if [ -d "$dir" ] && [ -f "${dir}Dockerfile" ]; then
                PROJECT_NAME=$(basename "$dir")
                if git diff --name-only HEAD~1 HEAD | grep -q "telegram-bots/${PROJECT_NAME}/"; then
                  CHANGED_PROJECTS="${CHANGED_PROJECTS}telegram-bots/${PROJECT_NAME},"
                fi
              fi
            done
          fi
          
          # Проверяем изменения в api-services
          if [[ "${{ steps.changes.outputs.api-services }}" == "true" ]]; then
            for dir in api-services/*/; do
              if [ -d "$dir" ] && [ -f "${dir}Dockerfile" ]; then
                PROJECT_NAME=$(basename "$dir")
                if git diff --name-only HEAD~1 HEAD | grep -q "api-services/${PROJECT_NAME}/"; then
                  CHANGED_PROJECTS="${CHANGED_PROJECTS}api-services/${PROJECT_NAME},"
                fi
              fi
            done
          fi
          
          # Проверяем изменения в web-apps
          if [[ "${{ steps.changes.outputs.web-apps }}" == "true" ]]; then
            for dir in web-apps/*/; do
              if [ -d "$dir" ] && [ -f "${dir}Dockerfile" ]; then
                PROJECT_NAME=$(basename "$dir")
                if git diff --name-only HEAD~1 HEAD | grep -q "web-apps/${PROJECT_NAME}/"; then
                  CHANGED_PROJECTS="${CHANGED_PROJECTS}web-apps/${PROJECT_NAME},"
                fi
              fi
            done
          fi
          
          # Убираем последнюю запятую
          CHANGED_PROJECTS=${CHANGED_PROJECTS%,}
          echo "projects=${CHANGED_PROJECTS}" >> $GITHUB_OUTPUT
          echo "Changed projects: ${CHANGED_PROJECTS}"

  build-and-push:
    name: Build and Push Images
    needs: detect-changes
    if: needs.detect-changes.outputs.projects != ''
    runs-on: ubuntu-latest
    strategy:
      matrix:
        project: ${{ fromJson(format('["{0}"]', needs.detect-changes.outputs.projects)) }}
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract project metadata
        id: meta
        run: |
          PROJECT_PATH="${{ matrix.project }}"
          PROJECT_NAME=$(echo "$PROJECT_PATH" | tr '/' '-')
          echo "project-name=${PROJECT_NAME}" >> $GITHUB_OUTPUT
          echo "project-path=${PROJECT_PATH}" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./${{ steps.meta.outputs.project-path }}
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ steps.meta.outputs.project-name }}:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ steps.meta.outputs.project-name }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    name: Trigger redeploy
    needs: [detect-changes, build-and-push]
    if: needs.detect-changes.outputs.projects != ''
    runs-on: ubuntu-latest
    steps:
      - name: Trigger redeploy
        run: |
          curl -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.REDEPLOY_TOKEN }}" \
            ${{ secrets.HOOK_HOST }}/hub


